ARG BASE_IMAGE=postgres:17.2-bookworm
FROM ${BASE_IMAGE}

# Set data environment variables from build/run args
ARG DATA_REL_DB
ARG DATA_REL_USER
ARG DATA_REL_PASSWORD
ARG DATA_REL_PORT_HOST
ARG DATA_REL_PORT_CONTAINER

ENV POSTGRES_DB=${DATA_REL_DB}
ENV POSTGRES_USER=${DATA_REL_USER}
ENV POSTGRES_PASSWORD=${DATA_REL_PASSWORD}
ENV DATA_REL_PORT_HOST=${DATA_REL_PORT_HOST}
ENV DATA_REL_PORT_CONTAINER=${DATA_REL_PORT_CONTAINER}

# Install unzip for data import
RUN apt-get update && apt-get install -y unzip && rm -rf /var/lib/apt/lists/*

# Ensure the database exists on init
RUN echo "\
DO \
$$ \
BEGIN \
   IF NOT EXISTS (SELECT FROM pg_database WHERE datname = '$DATA_REL_DB') THEN \
      CREATE DATABASE \"$DATA_REL_DB\"; \
   END IF; \
END \
$$;\
" > /docker-entrypoint-initdb.d/ensure_db.sql

# Expose data ports
EXPOSE 5432 ${DATA_REL_PORT_HOST} ${DATA_REL_PORT_CONTAINER}
